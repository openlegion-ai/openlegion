# Force amd64: sqlite-vec and Chromium have broken ARM wheels/binaries.
# Docker Desktop uses Rosetta 2 on Apple Silicon — fast and reliable.
FROM --platform=linux/amd64 python:3.12-slim

# System tools useful for agent operations
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl wget git jq vim-tiny procps \
    && rm -rf /var/lib/apt/lists/*

# Non-root user (created early so /data ownership is correct)
RUN useradd --create-home --uid 1000 --shell /bin/bash agent

WORKDIR /app

# Python dependencies — only what agents actually import
# (litellm, pyyaml, click, docker are host-only — not needed here)
# sqlite-vec requires amd64 (ARM wheels have broken 32-bit .so files)
COPY pyproject.toml .
RUN pip install --no-cache-dir \
    fastapi uvicorn httpx pydantic playwright sqlite-vec

# Install Chromium for browser automation — shared path so non-root agent can access it
ENV PLAYWRIGHT_BROWSERS_PATH=/opt/pw-browsers
RUN playwright install chromium --with-deps \
    && chmod -R o+rx /opt/pw-browsers

# Application code
COPY src/agent/ /app/src/agent/
COPY src/shared/ /app/src/shared/
COPY src/__init__.py /app/src/__init__.py

# Data volume mount point -- owned by agent user
RUN mkdir -p /data && chown agent:agent /data
VOLUME /data

RUN chown -R agent:agent /app

USER agent

EXPOSE 8400
CMD ["python", "-m", "src.agent"]
