<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OpenLegion Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gray: {
              950: '#0a0a0f',
              900: '#111118',
              850: '#16161f',
              800: '#1e1e2a',
              700: '#2a2a3a',
              600: '#3a3a4f',
            }
          },
          fontFamily: {
            mono: ['ui-monospace', 'SFMono-Regular', '"SF Mono"', 'Menlo', 'Consolas', 'monospace'],
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/dashboard/static/css/dashboard.css">
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">
  <script>
    window.__config = {
      wsUrl: (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + "{{ ws_path }}",
      apiBase: "{{ api_base }}"
    };
  </script>

  <div x-data="dashboard()" x-init="init()" class="flex flex-col h-screen">

    <!-- Toast notification -->
    <div x-show="toastMessage" x-cloak class="fixed bottom-4 right-4 z-50 toast text-gray-200" x-text="toastMessage" x-transition></div>

    <!-- Navigation bar -->
    <nav class="bg-gray-900 border-b border-gray-800 px-4 py-2.5 flex items-center justify-between shrink-0">
      <div class="flex items-center gap-5">
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 rounded-full bg-indigo-500"></div>
          <span class="text-base font-bold text-white tracking-tight">OpenLegion</span>
        </div>
        <div class="flex gap-0.5 bg-gray-800/50 rounded-lg p-0.5">
          <template x-for="tab in tabs" :key="tab.id">
            <button
              @click="switchTab(tab.id)"
              :class="activeTab === tab.id
                ? 'bg-gray-700 text-white shadow-sm'
                : 'text-gray-400 hover:text-gray-200 hover:bg-gray-800/70'"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-all relative"
            >
              <span x-text="tab.label"></span>
              <!-- Unread event count badge -->
              <span
                x-show="tab.id === 'activity' && unreadEvents > 0 && activeTab !== 'activity'"
                x-text="unreadEvents >= 100 ? '99+' : unreadEvents"
                class="absolute -top-1 -right-1 bg-indigo-500 text-white text-[10px] font-bold rounded-full min-w-[16px] h-4 flex items-center justify-center px-1"
                x-cloak
              ></span>
            </button>
          </template>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <!-- Fleet total cost (click to System > Costs) -->
        <div class="text-xs text-gray-400 hidden sm:block cursor-pointer hover:text-gray-200 transition-colors" x-show="fleetTotalCost > 0" @click="switchTab('system')">
          Today: <span class="text-gray-200 font-medium" x-text="formatCost(fleetTotalCost)"></span>
        </div>
        <!-- Connection indicator -->
        <div class="flex items-center gap-1.5 text-xs">
          <span class="relative flex h-2 w-2">
            <span :class="connected ? 'bg-green-400' : 'bg-red-400'" class="animate-ping absolute inline-flex h-full w-full rounded-full opacity-75" x-show="connected"></span>
            <span :class="connected ? 'bg-green-400' : 'bg-red-400'" class="relative inline-flex rounded-full h-2 w-2"></span>
          </span>
          <span :class="connected ? 'text-green-400' : 'text-red-400'" x-text="connected ? 'Live' : 'Disconnected'"></span>
        </div>
      </div>
    </nav>

    <!-- Main content -->
    <main class="flex-1 overflow-auto p-4 lg:p-6">

      <!-- Fleet Overview (merged: Fleet + Agents + Queues) -->
      <div x-show="activeTab === 'fleet'" x-cloak>
        <!-- Fleet summary bar -->
        <div class="flex items-center justify-between mb-4" x-show="agents.length > 0">
          <h2 class="text-sm font-medium text-gray-400">
            <span x-text="agents.length"></span> agent<span x-show="agents.length !== 1">s</span>
            <span class="text-gray-600 mx-1">&middot;</span>
            <span x-text="formatCost(fleetTotalCost)"></span> today
            <span class="text-gray-600 mx-1">&middot;</span>
            <span x-text="fleetTotalTokens.toLocaleString()"></span> tokens
          </h2>
          <div class="flex items-center gap-3">
            <button @click="addAgentMode = !addAgentMode; fetchSettings()"
              class="text-[11px] px-3 py-1.5 rounded-md transition-colors"
              :class="addAgentMode ? 'bg-indigo-600 text-white' : 'bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white'"
            >+ Add Agent</button>
            <div class="text-xs text-gray-600" x-text="'Updated ' + timeAgo(lastRefresh)"></div>
          </div>
        </div>
        <!-- Add agent form -->
        <div x-show="addAgentMode" x-cloak class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
              <label class="text-[11px] text-gray-500 mb-1 block">Name</label>
              <input type="text" x-model="addAgentForm.name" class="dash-input w-full" placeholder="my_agent">
            </div>
            <div>
              <label class="text-[11px] text-gray-500 mb-1 block">Role</label>
              <input type="text" x-model="addAgentForm.role" class="dash-input w-full" placeholder="assistant">
            </div>
            <div>
              <label class="text-[11px] text-gray-500 mb-1 block">Model</label>
              <select x-model="addAgentForm.model" class="dash-select w-full">
                <option value="">Default</option>
                <template x-for="m in availableModels" :key="m">
                  <option :value="m" x-text="m"></option>
                </template>
              </select>
            </div>
            <div>
              <label class="text-[11px] text-gray-500 mb-1 block">Browser</label>
              <select x-model="addAgentForm.browser_backend" class="dash-select w-full">
                <option value="">Default</option>
                <template x-for="b in availableBrowsers" :key="b">
                  <option :value="b" x-text="b"></option>
                </template>
              </select>
            </div>
          </div>
          <div class="flex gap-2 mt-3">
            <button @click="addAgent()" :disabled="addAgentLoading"
              class="text-xs px-4 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white disabled:opacity-50 transition-colors">
              <span x-show="!addAgentLoading">Add Agent</span>
              <span x-show="addAgentLoading">Adding...</span>
            </button>
            <button @click="addAgentMode = false" class="text-xs px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 transition-colors">Cancel</button>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          <template x-for="agent in agents" :key="agent.id">
            <div
              class="bg-gray-900 border border-gray-800 rounded-lg p-4 hover:border-gray-600 transition-all hover:shadow-lg hover:shadow-black/20 group"
              :class="agentStates[agent.id] === 'thinking' || agentStates[agent.id] === 'tool' ? 'pulse-border' : ''"
            >
              <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2 cursor-pointer" @click="drillDown(agent.id)" title="View agent details">
                  <span class="font-semibold text-white group-hover:text-indigo-300 transition-colors" x-text="agent.id"></span>
                  <svg class="w-3.5 h-3.5 text-gray-600 group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </div>
                <div class="flex items-center gap-2">
                  <!-- Queue depth badge -->
                  <span x-show="queueStatus[agent.id] && queueStatus[agent.id].queued > 0"
                    class="text-[10px] px-1.5 py-0.5 rounded-full bg-amber-900/30 text-amber-400 border border-amber-800/40 font-mono"
                    x-text="queueStatus[agent.id]?.queued + ' queued'"
                  ></span>
                  <span
                    class="text-[11px] px-2 py-0.5 rounded-full font-medium"
                    :class="{
                      'bg-green-900/40 text-green-400 border border-green-800/50': agent.health_status === 'healthy',
                      'bg-yellow-900/40 text-yellow-400 border border-yellow-800/50': agent.health_status === 'unhealthy' || agent.health_status === 'restarting',
                      'bg-red-900/40 text-red-400 border border-red-800/50': agent.health_status === 'failed',
                      'bg-gray-800/60 text-gray-500 border border-gray-700/50': agent.health_status === 'unknown',
                    }"
                    x-text="agent.health_status"
                  ></span>
                </div>
              </div>
              <div class="text-xs text-gray-500 truncate mb-2" x-show="agent.role" x-text="agent.role"></div>
              <div class="space-y-2 text-xs">
                <div class="flex justify-between items-center">
                  <span class="text-gray-500">Activity</span>
                  <span class="event-badge font-medium"
                    :class="{
                      'text-purple-400': agentStates[agent.id] === 'thinking',
                      'text-amber-400': agentStates[agent.id] === 'tool',
                      'text-gray-600': agentStates[agent.id] === 'idle' || !agentStates[agent.id],
                    }"
                    x-text="agentStates[agent.id] || 'idle'"
                  ></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-500">Cost today</span>
                  <span class="text-gray-200 font-mono text-[11px]" x-text="formatCost(agent.daily_cost)"></span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-gray-500">Tokens</span>
                  <span class="text-gray-200 font-mono text-[11px]" x-text="agent.daily_tokens.toLocaleString()"></span>
                </div>
                <div class="flex justify-between items-center" x-show="agentConfigs[agent.id]">
                  <span class="text-gray-500">Model</span>
                  <span class="text-gray-300 font-mono text-[11px]" x-text="agentConfigs[agent.id]?.model || '-'"></span>
                </div>
                <div class="flex justify-between items-center" x-show="queueStatus[agent.id]">
                  <span class="text-gray-500">Queue</span>
                  <span class="font-mono text-[11px]"
                    :class="queueStatus[agent.id]?.busy ? 'text-amber-400' : 'text-gray-600'"
                    x-text="queueStatus[agent.id]?.busy ? 'busy (' + queueStatus[agent.id]?.queued + ' queued)' : 'idle'"
                  ></span>
                </div>
                <div class="flex justify-between items-center" x-show="agent.restarts > 0">
                  <span class="text-gray-500">Restarts</span>
                  <span class="text-yellow-400 font-mono text-[11px]" x-text="agent.restarts"></span>
                </div>
              </div>
              <!-- Agent actions: Chat, Manage, Restart, Remove -->
              <div class="mt-3 pt-3 border-t border-gray-800/50 flex flex-wrap gap-1.5">
                <button
                  @click="openChat(agent.id)"
                  class="text-[11px] px-2 py-1 rounded bg-indigo-900/30 hover:bg-indigo-800/40 text-indigo-300 hover:text-indigo-200 border border-indigo-800/30 transition-colors"
                >Chat</button>
                <button
                  @click="drillDown(agent.id)"
                  class="text-[11px] px-2 py-1 rounded bg-purple-900/30 hover:bg-purple-800/40 text-purple-300 hover:text-purple-200 border border-purple-800/30 transition-colors"
                >Manage</button>
                <button
                  @click="restartAgent(agent.id)"
                  class="text-[11px] px-2 py-1 rounded bg-gray-800 hover:bg-amber-900/30 text-gray-400 hover:text-amber-400 transition-colors"
                >Restart</button>
                <button
                  @click="removeAgent(agent.id)"
                  class="text-[11px] px-2 py-1 rounded bg-gray-800 hover:bg-red-900/50 text-gray-400 hover:text-red-400 transition-colors"
                >Remove</button>
              </div>
            </div>
          </template>
        </div>
        <!-- Loading state -->
        <div x-show="agents.length === 0 && loading" class="text-center py-16" x-cloak>
          <div class="inline-flex items-center gap-2 text-gray-500">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
            Loading agents...
          </div>
        </div>
        <!-- Empty state -->
        <div x-show="agents.length === 0 && !loading" class="text-center py-16" x-cloak>
          <div class="text-gray-600 text-lg mb-2">No agents yet</div>
          <div class="text-gray-700 text-sm mb-4">Start agents with <code class="bg-gray-800 px-1.5 py-0.5 rounded text-gray-400">openlegion start</code> or add one here</div>
          <button @click="addAgentMode = true; fetchSettings()"
            class="text-sm px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white transition-colors">+ Add Agent</button>
        </div>
        <!-- Broadcast bar -->
        <div x-show="agents.length > 1" class="mt-6 bg-gray-900 border border-gray-800 rounded-lg p-4" x-cloak>
          <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Broadcast to all agents</div>
          <div class="flex gap-2">
            <input type="text" x-model="broadcastMessage" @keydown.enter="sendBroadcast()"
              class="dash-input flex-1" placeholder="Message all agents...">
            <button @click="sendBroadcast()" :disabled="broadcastLoading"
              class="text-xs px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white disabled:opacity-50 transition-colors">
              <span x-show="!broadcastLoading">Send</span>
              <span x-show="broadcastLoading">Sending...</span>
            </button>
          </div>
          <div x-show="broadcastResults" class="mt-3 space-y-2" x-cloak>
            <template x-for="[aid, resp] in Object.entries(broadcastResults || {})" :key="aid">
              <div class="text-xs bg-gray-800/50 rounded p-2" x-data="{ expanded: false }">
                <div class="flex items-start gap-2">
                  <span class="text-indigo-400 font-medium shrink-0" x-text="aid"></span>
                  <span class="text-gray-400 whitespace-pre-wrap break-words" x-text="expanded ? resp : resp.substring(0, 200)"></span>
                </div>
                <button x-show="resp.length > 200" @click="expanded = !expanded"
                  class="text-indigo-500 hover:text-indigo-400 mt-1 text-[10px]"
                  x-text="expanded ? 'Show less' : '...show more'"></button>
              </div>
            </template>
          </div>
        </div>
      </div>

      <!-- Chat modal overlay -->
      <div x-show="chatAgent" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/60" @click.self="closeChat()" @keydown.escape.window="if (chatAgent) closeChat()">
        <div class="bg-gray-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
          <div class="flex items-center justify-between px-5 py-3 border-b border-gray-800">
            <div class="flex items-center gap-3">
              <h3 class="text-sm font-medium text-white">Chat with <span class="text-indigo-400" x-text="chatAgent"></span></h3>
              <button x-show="(chatHistories[chatAgent] || []).length > 0" @click="clearChat()"
                class="text-[10px] text-gray-600 hover:text-gray-400 transition-colors" title="Clear chat history">Clear</button>
            </div>
            <button @click="closeChat()" class="text-gray-500 hover:text-white transition-colors text-lg">&times;</button>
          </div>
          <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar min-h-[200px]">
            <template x-for="(msg, i) in (chatHistories[chatAgent] || [])" :key="i">
              <div :class="msg.role === 'user' ? 'text-right' : 'text-left'">
                <div class="inline-block max-w-[80%] px-3 py-2 rounded-lg text-sm"
                  :class="{
                    'bg-indigo-600 text-white': msg.role === 'user',
                    'bg-gray-800 text-gray-200': msg.role === 'agent',
                    'bg-red-900/40 text-red-300': msg.role === 'error',
                  }"
                >
                  <!-- Tool calls -->
                  <template x-if="msg.tools && msg.tools.length > 0">
                    <div class="mb-2 space-y-1">
                      <template x-for="(tool, ti) in msg.tools" :key="ti">
                        <div class="flex items-center gap-1.5 text-xs py-1 px-2 rounded bg-gray-900/60 text-gray-400">
                          <template x-if="tool.status === 'running'">
                            <svg class="animate-spin h-3 w-3 text-indigo-400 shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                          </template>
                          <template x-if="tool.status === 'done'">
                            <span class="text-emerald-400 shrink-0">&#10003;</span>
                          </template>
                          <span class="font-mono truncate" x-text="tool.name"></span>
                          <span x-show="tool.output" class="text-gray-600 truncate ml-1" x-text="tool.output ? 'â†’ ' + tool.output : ''"></span>
                        </div>
                      </template>
                    </div>
                  </template>
                  <!-- Message content -->
                  <div class="whitespace-pre-wrap break-words" x-text="msg.content"></div>
                  <!-- Streaming cursor -->
                  <span x-show="msg.streaming" class="inline-block w-1.5 h-4 bg-indigo-400 animate-pulse ml-0.5 align-text-bottom"></span>
                </div>
              </div>
            </template>
            <div x-show="chatLoading" class="text-center text-gray-600 text-sm">
              <svg class="animate-spin h-4 w-4 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
              Thinking...
            </div>
          </div>
          <div class="px-4 py-3 border-t border-gray-800">
            <div class="flex gap-2">
              <input type="text" x-model="chatMessage" @keydown.enter="sendChat()"
                class="dash-input flex-1" placeholder="Type a message..." :disabled="chatStreaming">
              <button @click="sendChat()" :disabled="chatStreaming || chatLoading || !chatMessage.trim()"
                class="text-xs px-4 py-2 rounded bg-indigo-600 hover:bg-indigo-500 text-white disabled:opacity-50 transition-colors">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Activity Feed (Traces + Live Events) -->
      <div x-show="activeTab === 'activity'" x-cloak>
        <!-- Sub-tab toggle -->
        <div class="flex items-center justify-between mb-3">
          <div class="flex gap-0.5 bg-gray-800/50 rounded-lg p-0.5">
            <button @click="setActivityView('traces')"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-all"
              :class="activityView === 'traces' ? 'bg-gray-700 text-white shadow-sm' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-800/70'"
            >Traces</button>
            <button @click="setActivityView('events')"
              class="px-3 py-1.5 rounded-md text-sm font-medium transition-all"
              :class="activityView === 'events' ? 'bg-gray-700 text-white shadow-sm' : 'text-gray-400 hover:text-gray-200 hover:bg-gray-800/70'"
            >Live Events</button>
          </div>
          <span x-show="activityView === 'events'" class="text-xs text-gray-600" x-text="filteredEvents.length + ' events'"></span>
          <span x-show="activityView === 'traces'" class="text-xs text-gray-600" x-text="traces.length + ' traces'"></span>
        </div>

        <!-- Traces view -->
        <div x-show="activityView === 'traces'">
          <div class="space-y-1 max-h-[calc(100vh-10rem)] overflow-y-auto custom-scrollbar">
            <template x-for="t in traces" :key="t.trace_id">
              <div>
                <div @click="toggleTraceExpand(t.trace_id)"
                  class="bg-gray-900/70 border border-gray-800/60 px-3 py-2 flex items-center gap-2.5 text-sm hover:bg-gray-900 transition-colors cursor-pointer select-none"
                  :class="expandedTraces[t.trace_id] ? 'rounded-t-md' : 'rounded-md'"
                >
                  <svg class="w-3 h-3 shrink-0 text-gray-600 transition-transform duration-200" :class="expandedTraces[t.trace_id] && 'rotate-90'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                  <span class="w-2 h-2 rounded-full shrink-0" :class="eventBgColor(t.first_event_type || 'chat')"></span>
                  <span class="text-gray-400 text-xs shrink-0 w-24 truncate" x-text="t.agents.join(', ') || '-'"></span>
                  <span class="text-gray-300 truncate flex-1" x-text="t.trigger_preview || t.trigger_detail || t.trace_id.substring(0, 12)"></span>
                  <span class="text-gray-600 text-[10px] font-mono shrink-0" x-text="t.event_count + ' events'"></span>
                  <span x-show="t.total_duration_ms > 0" class="text-gray-700 text-[10px] font-mono shrink-0" x-text="t.total_duration_ms + 'ms'"></span>
                  <span x-show="t.has_error" class="text-[10px] px-1.5 py-0.5 rounded-full bg-red-900/30 text-red-400 border border-red-800/40 shrink-0">ERR</span>
                  <span class="text-gray-700 text-xs font-mono shrink-0" x-text="timeAgo(t.started)"></span>
                </div>
                <!-- Expanded trace detail -->
                <template x-if="expandedTraces[t.trace_id]">
                  <div class="bg-gray-900 border border-gray-800/80 border-t-gray-700/50 rounded-b-md px-4 py-3">
                    <!-- Loading spinner -->
                    <div x-show="expandedTraces[t.trace_id]?.loading" class="text-center py-4">
                      <div class="inline-flex items-center gap-2 text-gray-600 text-sm">
                        <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                        Loading...
                      </div>
                    </div>
                    <!-- Event timeline -->
                    <div x-show="!expandedTraces[t.trace_id]?.loading" class="space-y-0 max-h-80 overflow-y-auto custom-scrollbar">
                      <template x-for="(evt, ei) in (expandedTraces[t.trace_id]?.events || [])" :key="ei">
                        <div class="relative pl-6 border-l-2 pb-3 last:pb-0" :class="evt.status === 'error' ? 'border-red-900/50' : 'border-gray-800'">
                          <div class="absolute left-[-5px] top-1.5 w-2 h-2 rounded-full" :class="evt.status === 'error' ? 'bg-red-500' : eventBgColor(evt.event_type)"></div>
                          <div class="flex items-center gap-2 text-sm">
                            <span class="event-badge" :class="eventColor(evt.event_type)" x-text="evt.event_type"></span>
                            <span class="text-gray-500 text-xs" x-text="evt.source"></span>
                            <span x-show="evt.agent" class="text-gray-600 text-xs" x-text="evt.agent"></span>
                            <span x-show="evt.duration_ms > 0" class="text-gray-600 text-xs font-mono" x-text="evt.duration_ms + 'ms'"></span>
                            <span x-show="evt.status === 'error'" class="text-red-400 text-xs font-medium">FAILED</span>
                          </div>
                          <div class="text-xs text-gray-400 mt-0.5 font-mono" x-text="evt.detail" x-show="evt.detail"></div>
                          <div x-show="evt.error" class="text-xs text-red-400/80 mt-0.5 font-mono" x-text="evt.error"></div>
                          <template x-if="evt.meta && Object.keys(evt.meta).length > 0">
                            <div class="mt-1 flex flex-wrap gap-x-3 gap-y-0.5">
                              <template x-for="[k, v] in Object.entries(evt.meta)" :key="k">
                                <span class="text-[10px] text-gray-600"><span class="text-gray-700" x-text="k"></span>=<span class="text-gray-500" x-text="typeof v === 'string' && v.length > 80 ? v.substring(0, 80) + '...' : v"></span></span>
                              </template>
                            </div>
                          </template>
                        </div>
                      </template>
                      <div x-show="(expandedTraces[t.trace_id]?.events || []).length === 0 && !expandedTraces[t.trace_id]?.loading" class="text-gray-600 text-sm py-2 text-center">No events in trace</div>
                    </div>
                  </div>
                </template>
              </div>
            </template>
            <!-- Loading state -->
            <div x-show="traces.length === 0 && tracesLoading" class="text-center py-16">
              <div class="inline-flex items-center gap-2 text-gray-500">
                <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                Loading traces...
              </div>
            </div>
            <!-- Empty state -->
            <div x-show="traces.length === 0 && !tracesLoading" class="text-center py-16">
              <div class="text-gray-600 text-lg mb-1">No traces yet</div>
              <div class="text-gray-700 text-sm">Traces appear as agents process requests</div>
            </div>
          </div>
        </div>

        <!-- Live Events view -->
        <div x-show="activityView === 'events'">
          <div class="flex items-center justify-between mb-3">
            <div class="flex gap-1.5 flex-wrap">
              <template x-for="etype in eventTypes" :key="etype">
                <button
                  @click="toggleEventFilter(etype)"
                  class="text-[11px] px-2 py-1 rounded-md border transition-all"
                  :class="eventFilters.has(etype)
                    ? 'border-indigo-500/60 bg-indigo-900/20 text-indigo-300'
                    : 'border-gray-800 text-gray-600 hover:text-gray-400 hover:border-gray-700'"
                  x-text="etype"
                ></button>
              </template>
              <button
                x-show="eventFilters.size > 0"
                @click="eventFilters.clear()"
                class="text-[11px] px-2 py-1 rounded-md text-gray-600 hover:text-gray-400"
              >Clear</button>
            </div>
          </div>
          <div class="space-y-1 max-h-[calc(100vh-12rem)] overflow-y-auto custom-scrollbar">
            <template x-for="(evt, i) in filteredEvents" :key="i">
              <div x-data="{ open: false }">
                <div @click="open = !open" class="bg-gray-900/70 border border-gray-800/60 px-3 py-2 flex items-start gap-3 text-sm hover:bg-gray-900 transition-colors cursor-pointer select-none" :class="open ? 'rounded-t-md' : 'rounded-md'">
                  <svg class="w-3 h-3 shrink-0 mt-1 text-gray-600 transition-transform duration-200" :class="open && 'rotate-90'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                  <span class="event-badge shrink-0 mt-0.5" :class="eventColor(evt.type)" x-text="evt.type"></span>
                  <span class="text-gray-500 shrink-0 w-20 truncate" x-text="evt.agent || '-'"></span>
                  <span class="text-gray-300 truncate flex-1" x-text="eventSummary(evt)"></span>
                  <span class="text-gray-700 text-xs shrink-0 font-mono" x-text="timeAgo(evt.timestamp)"></span>
                </div>
                <template x-if="open">
                  <div class="bg-gray-900 border border-gray-800/80 border-t-gray-700/50 rounded-b-md px-4 py-3">
                    <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-1.5 text-xs">
                      <template x-for="(field, fi) in eventDetail(evt)" :key="fi">
                        <div class="contents">
                          <span class="text-gray-600 whitespace-nowrap" x-text="field.label"></span>
                          <span class="text-gray-300 font-mono whitespace-pre-wrap break-all max-h-48 overflow-y-auto" x-text="field.value"></span>
                        </div>
                      </template>
                    </div>
                  </div>
                </template>
              </div>
            </template>
            <!-- Empty state -->
            <div x-show="filteredEvents.length === 0" class="text-center py-16">
              <div class="text-gray-600 text-lg mb-1">No events yet</div>
              <div class="text-gray-700 text-sm">Events appear in real-time as agents work</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Agent Detail -->
      <div x-show="activeTab === 'agent-detail'" x-cloak @keydown.escape.window="if (activeTab === 'agent-detail' && !identityEditing && !configEditing && !chatAgent) switchTab('fleet')">
        <button @click="switchTab('fleet')" class="text-sm text-gray-500 hover:text-gray-300 mb-4 flex items-center gap-1 transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          Back to agents
        </button>
        <!-- Loading -->
        <div x-show="!agentDetail && selectedAgent" class="text-center py-12" x-cloak>
          <div class="inline-flex items-center gap-2 text-gray-500">
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
            Loading...
          </div>
        </div>
        <template x-if="agentDetail">
          <div>
            <div class="flex items-center justify-between mb-5">
              <div class="flex items-center gap-3">
                <h2 class="text-xl font-bold" x-text="agentDetail.id"></h2>
                <span
                  class="text-[11px] px-2 py-0.5 rounded-full font-medium"
                  :class="{
                    'bg-green-900/40 text-green-400 border border-green-800/50': agentDetail.health?.status === 'healthy',
                    'bg-yellow-900/40 text-yellow-400 border border-yellow-800/50': agentDetail.health?.status === 'unhealthy',
                    'bg-red-900/40 text-red-400 border border-red-800/50': agentDetail.health?.status === 'failed',
                    'bg-gray-800/60 text-gray-500 border border-gray-700/50': !agentDetail.health?.status || agentDetail.health?.status === 'unknown',
                  }"
                  x-text="agentDetail.health?.status || 'unknown'"
                ></span>
                <span class="text-xs text-gray-600 font-mono" x-text="agentDetail.url"></span>
              </div>
              <div class="flex items-center gap-2">
                <button @click="openChat(selectedAgent)"
                  class="text-[11px] px-3 py-1.5 rounded bg-indigo-900/30 hover:bg-indigo-800/40 text-indigo-300 hover:text-indigo-200 border border-indigo-800/30 transition-colors"
                >Chat</button>
                <button @click="restartAgent(selectedAgent)"
                  class="text-[11px] px-3 py-1.5 rounded bg-gray-800 hover:bg-amber-900/30 text-gray-400 hover:text-amber-400 transition-colors"
                >Restart</button>
              </div>
            </div>
            <!-- Agent Identity Panel -->
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-5">
              <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Agent Identity</div>
              <!-- Tab bar -->
              <div class="flex gap-0.5 bg-gray-800/50 rounded-lg p-0.5 mb-3 overflow-x-auto">
                <template x-for="tab in identityTabs" :key="tab.id">
                  <button
                    @click="switchIdentityTab(selectedAgent, tab.id)"
                    class="px-2.5 py-1.5 rounded-md text-xs font-medium transition-all flex items-center gap-1.5"
                    :class="identityTab === tab.id
                      ? 'bg-gray-700 text-white shadow-sm'
                      : 'text-gray-400 hover:text-gray-200 hover:bg-gray-800/70'"
                  >
                    <span x-text="tab.label"></span>
                    <!-- Access badge -->
                    <span x-show="tab.access === 'user'"
                      class="text-[9px] px-1 py-0 rounded-full bg-blue-900/40 text-blue-400 border border-blue-800/30 font-normal"
                      title="Only you can edit this file"
                    >User</span>
                    <span x-show="tab.access === 'agent'"
                      class="text-[9px] px-1 py-0 rounded-full bg-purple-900/40 text-purple-400 border border-purple-800/30 font-normal"
                      title="The agent can update this file"
                    >Agent</span>
                    <span x-show="tab.access === 'auto'"
                      class="text-[9px] px-1 py-0 rounded-full bg-gray-700/50 text-gray-500 border border-gray-600/30 font-normal"
                      title="Auto-generated, read-only"
                    >Auto</span>
                  </button>
                </template>
              </div>
              <!-- Tab description -->
              <div class="text-xs text-gray-500 mb-3">
                <span x-text="identityCurrentTab.desc"></span>
                <span
                  x-show="identityCurrentTab.file && identityFiles.find(f => f.name === identityCurrentTab.file)?.is_default"
                  class="inline-block ml-1.5 text-[9px] px-1 py-0 rounded-full bg-gray-600/50 text-gray-400 font-normal align-middle"
                >default</span>
              </div>
              <!-- Character budget bar (file tabs with a cap) -->
              <div x-show="identityCurrentTab.cap" class="mb-3">
                <div class="flex justify-between items-center text-[11px] text-gray-500 mb-1">
                  <span x-text="identityCharCount.toLocaleString() + ' / ' + (identityCurrentTab.cap || 0).toLocaleString() + ' chars'"></span>
                  <span x-text="Math.round(identityBudgetPct) + '%'"></span>
                </div>
                <div class="w-full bg-gray-800 rounded-full h-1">
                  <div class="h-1 rounded-full transition-all duration-300"
                    :class="identityBudgetColor"
                    :style="'width:' + identityBudgetPct + '%'"
                  ></div>
                </div>
              </div>
              <!-- Char count only (file tabs without a cap, e.g. Heartbeat) -->
              <div x-show="identityCurrentTab.file && !identityCurrentTab.cap" class="mb-3">
                <div class="text-[11px] text-gray-500" x-text="identityCharCount.toLocaleString() + ' chars'"></div>
              </div>
              <!-- Loading -->
              <div x-show="identityContentLoading || identityLoading || identityLogsLoading || identityLearningsLoading" class="py-6 text-center text-gray-600 text-sm">
                <svg class="animate-spin h-4 w-4 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                Loading...
              </div>
              <!-- Empty state when workspace unavailable -->
              <div x-show="identityFiles.length === 0 && !identityLoading && identityCurrentTab.file" class="text-gray-600 text-sm py-6 text-center">
                No workspace available for this agent
              </div>
              <!-- Editable file tabs (Soul, Instructions, Preferences, Heartbeat, Memory) -->
              <div x-show="identityCurrentTab.file && identityFiles.length > 0 && !identityContentLoading && !identityLoading">
                <!-- Read-only view -->
                <div x-show="!identityEditing">
                  <div class="flex items-center justify-between mb-2">
                    <span class="font-mono text-xs text-gray-500" x-text="identityCurrentTab.file"></span>
                    <button @click="startIdentityEdit()"
                      class="text-[11px] px-3 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white transition-colors">Edit</button>
                  </div>
                  <pre class="bg-gray-800/50 border border-gray-700/50 rounded p-3 text-sm text-gray-300 font-mono whitespace-pre-wrap break-words max-h-72 overflow-y-auto custom-scrollbar"
                    x-text="identityContent[identityCurrentTab.file] || '(empty)'"></pre>
                </div>
                <!-- Edit mode -->
                <div x-show="identityEditing">
                  <div class="flex items-center justify-between mb-2">
                    <span class="font-mono text-xs text-blue-400" x-text="identityCurrentTab.file"></span>
                    <div class="flex gap-2">
                      <button @click="saveIdentityFile(selectedAgent)"
                        :disabled="identitySaving"
                        class="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-500 text-white rounded disabled:opacity-50 transition-colors">
                        <span x-text="identitySaving ? 'Saving...' : 'Save'"></span>
                      </button>
                      <button @click="cancelIdentityEdit()"
                        class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition-colors">Cancel</button>
                    </div>
                  </div>
                  <textarea x-model="identityEditBuffer"
                    @keydown.ctrl.s.prevent="saveIdentityFile(selectedAgent)"
                    @keydown.meta.s.prevent="saveIdentityFile(selectedAgent)"
                    class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-sm text-gray-200 font-mono resize-y focus:border-indigo-500 focus:outline-none"
                    rows="15" spellcheck="false"></textarea>
                </div>
              </div>
              <!-- Activity tab (read-only logs) -->
              <div x-show="identityTab === 'activity' && !identityLogsLoading && !identityLoading">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-gray-500">Daily logs (last 3 days)</span>
                  <button @click="fetchIdentityLogs(selectedAgent)"
                    class="text-[11px] px-2.5 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white transition-colors">Refresh</button>
                </div>
                <div x-show="!identityLogs" class="text-gray-600 text-sm py-4 text-center">No daily logs found</div>
                <pre x-show="identityLogs"
                  class="bg-gray-800/50 border border-gray-700/50 rounded p-3 text-sm text-gray-300 font-mono whitespace-pre-wrap break-words max-h-80 overflow-y-auto custom-scrollbar"
                  x-text="identityLogs"></pre>
              </div>
              <!-- Learnings tab (read-only errors + corrections) -->
              <div x-show="identityTab === 'learnings' && !identityLearningsLoading && !identityLoading">
                <div class="flex items-center justify-between mb-3">
                  <span class="text-xs text-gray-500">Errors and user corrections</span>
                  <button @click="fetchIdentityLearnings(selectedAgent)"
                    class="text-[11px] px-2.5 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white transition-colors">Refresh</button>
                </div>
                <!-- Errors section -->
                <div class="mb-4">
                  <div class="text-xs font-medium text-red-400/80 mb-1.5">Errors</div>
                  <div x-show="!identityLearnings?.errors" class="text-gray-600 text-sm py-2 text-center">No errors recorded</div>
                  <pre x-show="identityLearnings?.errors"
                    class="bg-red-950/20 border border-red-900/30 rounded p-3 text-xs text-gray-300 font-mono whitespace-pre-wrap break-words max-h-48 overflow-y-auto custom-scrollbar"
                    x-text="identityLearnings?.errors"></pre>
                </div>
                <!-- Corrections section -->
                <div>
                  <div class="text-xs font-medium text-amber-400/80 mb-1.5">Corrections</div>
                  <div x-show="!identityLearnings?.corrections" class="text-gray-600 text-sm py-2 text-center">No corrections recorded</div>
                  <pre x-show="identityLearnings?.corrections"
                    class="bg-amber-950/20 border border-amber-900/30 rounded p-3 text-xs text-gray-300 font-mono whitespace-pre-wrap break-words max-h-48 overflow-y-auto custom-scrollbar"
                    x-text="identityLearnings?.corrections"></pre>
                </div>
              </div>
              <!-- Loading states for activity/learnings -->
              <div x-show="(identityTab === 'activity' && identityLogsLoading) || (identityTab === 'learnings' && identityLearningsLoading)" class="py-6 text-center text-gray-600 text-sm">
                <svg class="animate-spin h-4 w-4 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                Loading...
              </div>
              <!-- Config tab -->
              <div x-show="identityTab === 'config' && !identityLoading">
                <!-- Loading state -->
                <div x-show="!agentConfigs[selectedAgent]" class="py-6 text-center text-gray-600 text-sm">
                  <svg class="animate-spin h-4 w-4 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                  Loading config...
                </div>
                <!-- Read-only view -->
                <div x-show="agentConfigs[selectedAgent] && !configEditing">
                  <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-500">Agent configuration</span>
                    <button @click="startConfigEdit()"
                      class="text-[11px] px-3 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white transition-colors">Edit</button>
                  </div>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-gray-800/50 rounded p-3">
                      <div class="text-[11px] text-gray-500 mb-1">Model</div>
                      <div class="text-sm text-gray-200 font-mono" x-text="agentConfigs[selectedAgent]?.model || '-'"></div>
                    </div>
                    <div class="bg-gray-800/50 rounded p-3">
                      <div class="text-[11px] text-gray-500 mb-1">Browser Backend</div>
                      <div class="text-sm text-gray-200 font-mono" x-text="agentConfigs[selectedAgent]?.browser_backend || '-'"></div>
                    </div>
                    <div class="bg-gray-800/50 rounded p-3">
                      <div class="text-[11px] text-gray-500 mb-1">Role</div>
                      <div class="text-sm text-gray-200" x-text="agentConfigs[selectedAgent]?.role || '-'"></div>
                    </div>
                    <div class="bg-gray-800/50 rounded p-3">
                      <div class="text-[11px] text-gray-500 mb-1">Budget ($/day)</div>
                      <div class="text-sm text-gray-200 font-mono" x-text="agentConfigs[selectedAgent]?.budget?.daily_usd ? formatCost(agentConfigs[selectedAgent].budget.daily_usd) : '-'"></div>
                    </div>
                  </div>
                  <div x-show="agentConfigs[selectedAgent]?.system_prompt" class="mt-3 bg-gray-800/50 rounded p-3">
                    <div class="text-[11px] text-gray-500 mb-1">System Prompt</div>
                    <pre class="text-xs text-gray-300 font-mono whitespace-pre-wrap break-words max-h-48 overflow-y-auto custom-scrollbar" x-text="agentConfigs[selectedAgent]?.system_prompt"></pre>
                  </div>
                </div>
                <!-- Edit mode -->
                <div x-show="agentConfigs[selectedAgent] && configEditing">
                  <div class="space-y-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      <div>
                        <label class="text-[11px] text-gray-500 mb-1 block">Model</label>
                        <select x-model="editForm.model" class="dash-select w-full">
                          <template x-for="m in availableModels" :key="m">
                            <option :value="m" x-text="m"></option>
                          </template>
                        </select>
                      </div>
                      <div>
                        <label class="text-[11px] text-gray-500 mb-1 block">Browser Backend</label>
                        <select x-model="editForm.browser_backend" class="dash-select w-full">
                          <template x-for="b in availableBrowsers" :key="b">
                            <option :value="b" x-text="b"></option>
                          </template>
                        </select>
                      </div>
                      <div>
                        <label class="text-[11px] text-gray-500 mb-1 block">Role</label>
                        <input type="text" x-model="editForm.role" class="dash-input w-full">
                      </div>
                      <div>
                        <label class="text-[11px] text-gray-500 mb-1 block">Budget ($/day)</label>
                        <input type="number" step="0.5" min="0.1" x-model="editForm.budget_daily" class="dash-input w-full" placeholder="10.0">
                      </div>
                    </div>
                    <div>
                      <label class="text-[11px] text-gray-500 mb-1 block">System Prompt</label>
                      <textarea x-model="editForm.system_prompt"
                        class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-sm text-gray-200 font-mono resize-y focus:border-indigo-500 focus:outline-none"
                        rows="6" spellcheck="false"></textarea>
                    </div>
                    <div class="flex gap-2">
                      <button @click="saveConfigFromDetail(selectedAgent)" :disabled="configSaving"
                        class="text-xs px-4 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white disabled:opacity-50 transition-colors">
                        <span x-text="configSaving ? 'Saving...' : 'Save'"></span>
                      </button>
                      <button @click="cancelConfigEdit()"
                        class="text-xs px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 transition-colors">Cancel</button>
                      <button @click="resetAgent(selectedAgent)"
                        class="text-xs px-3 py-1.5 rounded text-gray-600 hover:text-red-400 transition-colors ml-auto">Reset Conversation</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Spend / Health summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-5">
              <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Spend Today</div>
                <div class="text-2xl font-bold font-mono" x-text="formatCost(agentDetail.spend_today?.total_cost || 0)"></div>
                <div class="text-xs text-gray-500 mt-1" x-text="(agentDetail.spend_today?.total_tokens || 0).toLocaleString() + ' tokens'"></div>
              </div>
              <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Spend This Week</div>
                <div class="text-2xl font-bold font-mono" x-text="formatCost(agentDetail.spend_week?.total_cost || 0)"></div>
                <div class="text-xs text-gray-500 mt-1" x-text="(agentDetail.spend_week?.total_tokens || 0).toLocaleString() + ' tokens'"></div>
              </div>
              <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-2">Health</div>
                <div class="space-y-1.5 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-500">Failures</span>
                    <span class="font-mono" x-text="agentDetail.health?.failures || 0"></span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-500">Restarts</span>
                    <span class="font-mono" x-text="agentDetail.health?.restarts || 0"></span>
                  </div>
                </div>
              </div>
            </div>
            <!-- Budget bar -->
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-5">
              <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Budget</div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <div class="flex justify-between text-sm mb-1.5">
                    <span class="text-gray-400">Daily</span>
                    <span class="font-mono text-xs" x-text="formatCost(agentDetail.budget?.daily_used || 0) + ' / ' + formatCost(agentDetail.budget?.daily_limit || 0)"></span>
                  </div>
                  <div class="w-full bg-gray-800 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full transition-all duration-500"
                      :class="(agentDetail.budget?.daily_used || 0) / (agentDetail.budget?.daily_limit || 1) > 0.8 ? 'bg-red-500' : 'bg-indigo-500'"
                      :style="'width:' + Math.min(100, ((agentDetail.budget?.daily_used || 0) / (agentDetail.budget?.daily_limit || 1)) * 100) + '%'"
                    ></div>
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-1.5">
                    <span class="text-gray-400">Monthly</span>
                    <span class="font-mono text-xs" x-text="formatCost(agentDetail.budget?.monthly_used || 0) + ' / ' + formatCost(agentDetail.budget?.monthly_limit || 0)"></span>
                  </div>
                  <div class="w-full bg-gray-800 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full transition-all duration-500"
                      :class="(agentDetail.budget?.monthly_used || 0) / (agentDetail.budget?.monthly_limit || 1) > 0.8 ? 'bg-red-500' : 'bg-indigo-500'"
                      :style="'width:' + Math.min(100, ((agentDetail.budget?.monthly_used || 0) / (agentDetail.budget?.monthly_limit || 1)) * 100) + '%'"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Per-model cost breakdown -->
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-5" x-show="agentDetail.spend_today?.by_model && Object.keys(agentDetail.spend_today.by_model).length > 0">
              <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Cost by Model (Today)</div>
              <div class="space-y-1.5">
                <template x-for="[model, data] in Object.entries(agentDetail.spend_today?.by_model || {})" :key="model">
                  <div class="flex justify-between text-xs">
                    <span class="text-gray-400 font-mono" x-text="model"></span>
                    <div class="flex gap-4">
                      <span class="text-gray-500" x-text="(data.total || 0).toLocaleString() + ' tok'"></span>
                      <span class="text-gray-300 font-mono" x-text="formatCost(data.cost || 0)"></span>
                    </div>
                  </div>
                </template>
              </div>
            </div>
            <!-- Recent events for this agent -->
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
              <div class="flex items-center justify-between mb-3">
                <div class="text-xs text-gray-500 uppercase tracking-wider">Recent Events</div>
                <span class="text-xs text-gray-700" x-text="agentEvents.length + ' events'"></span>
              </div>
              <div class="space-y-1 max-h-72 overflow-y-auto custom-scrollbar">
                <template x-for="(evt, i) in agentEvents" :key="i">
                  <div x-data="{ open: false }">
                    <div @click="open = !open" class="flex items-center gap-2 text-sm py-1.5 border-b border-gray-800/30 last:border-0 cursor-pointer hover:bg-gray-800/30 transition-colors select-none">
                      <svg class="w-2.5 h-2.5 shrink-0 text-gray-700 transition-transform duration-200" :class="open && 'rotate-90'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                      <span class="event-badge" :class="eventColor(evt.type)" x-text="evt.type"></span>
                      <span class="text-gray-300 truncate flex-1" x-text="eventSummary(evt)"></span>
                      <span class="text-gray-700 text-xs ml-auto shrink-0 font-mono" x-text="timeAgo(evt.timestamp)"></span>
                    </div>
                    <template x-if="open">
                      <div class="bg-gray-800/40 rounded px-3 py-2 mb-1">
                        <div class="grid grid-cols-[auto_1fr] gap-x-3 gap-y-1 text-xs">
                          <template x-for="(field, fi) in eventDetail(evt)" :key="fi">
                            <div class="contents">
                              <span class="text-gray-600 whitespace-nowrap" x-text="field.label"></span>
                              <span class="text-gray-300 font-mono whitespace-pre-wrap break-all max-h-36 overflow-y-auto" x-text="field.value"></span>
                            </div>
                          </template>
                        </div>
                      </div>
                    </template>
                  </div>
                </template>
                <div x-show="agentEvents.length === 0" class="text-gray-600 text-sm py-4 text-center">No recent events for this agent</div>
              </div>
            </div>
          </div>
        </template>
      </div>

      <!-- Blackboard -->
      <div x-show="activeTab === 'blackboard'" x-cloak>
        <!-- PROJECT.md editor -->
        <div class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
          <div class="flex items-center justify-between mb-3">
            <div class="flex items-center gap-2">
              <div class="text-xs text-gray-500 uppercase tracking-wider">PROJECT.md</div>
              <span class="text-[10px] px-1.5 py-0.5 rounded-full bg-indigo-900/30 text-indigo-400 border border-indigo-800/30">fleet-wide</span>
            </div>
            <div class="flex items-center gap-2">
              <span x-show="projectLoading" class="text-gray-600 text-xs">
                <svg class="animate-spin h-3 w-3 inline mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
              </span>
              <button x-show="!projectEditing && !projectLoading" @click="fetchProject()"
                class="text-[11px] px-2 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-500 hover:text-white transition-colors" title="Refresh">
                <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 9a8 8 0 0114.32-3.2M20 15a8 8 0 01-14.32 3.2"/></svg>
              </button>
              <button x-show="!projectEditing && !projectLoading" @click="startProjectEdit()"
                class="text-[11px] px-3 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white transition-colors">Edit</button>
            </div>
          </div>
          <div class="text-xs text-gray-600 mb-3">Shared project context loaded into every agent's system prompt. Changes push to all running agents.</div>
          <!-- Read-only view -->
          <div x-show="!projectEditing && !projectLoading">
            <div x-show="!projectContent && !projectExists" class="text-gray-600 text-sm py-4 text-center">No PROJECT.md found. Click Edit to create one.</div>
            <div x-show="!projectContent && projectExists" class="text-gray-600 text-sm py-4 text-center">PROJECT.md is empty. Click Edit to add content.</div>
            <pre x-show="projectContent"
              class="bg-gray-800/50 border border-gray-700/50 rounded p-3 text-sm text-gray-300 font-mono whitespace-pre-wrap break-words max-h-48 overflow-y-auto custom-scrollbar"
              x-text="projectContent"></pre>
            <div x-show="projectContent" class="text-[11px] text-gray-600 mt-1" x-text="projectContent.length.toLocaleString() + ' chars'"></div>
          </div>
          <!-- Edit mode -->
          <div x-show="projectEditing">
            <textarea x-model="projectEditBuffer"
              @keydown.ctrl.s.prevent="saveProject()"
              @keydown.meta.s.prevent="saveProject()"
              class="w-full bg-gray-800 border border-gray-700 rounded p-3 text-sm text-gray-200 font-mono resize-y focus:border-indigo-500 focus:outline-none"
              rows="10" spellcheck="false" placeholder="# Project Context&#10;&#10;Describe your project goals, architecture, team conventions..."></textarea>
            <div class="flex items-center justify-between mt-2">
              <span class="text-[11px] text-gray-600" x-text="projectEditBuffer.length.toLocaleString() + ' chars'"></span>
              <div class="flex gap-2">
                <button @click="saveProject()" :disabled="projectSaving"
                  class="px-3 py-1 text-xs bg-indigo-600 hover:bg-indigo-500 text-white rounded disabled:opacity-50 transition-colors">
                  <span x-text="projectSaving ? 'Saving...' : 'Save'"></span>
                </button>
                <button @click="cancelProjectEdit()"
                  class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded transition-colors">Cancel</button>
              </div>
            </div>
          </div>
        </div>
        <div class="mb-3 flex gap-2">
          <input
            type="text"
            x-model="bbPrefix"
            @keyup.enter="fetchBlackboard()"
            placeholder="Filter by prefix (e.g. tasks/, context/, signals/)"
            class="bg-gray-900 border border-gray-800 rounded-lg px-3 py-2 text-sm flex-1 focus:outline-none focus:border-gray-600 focus:ring-1 focus:ring-gray-600 placeholder-gray-700 transition-colors"
          >
          <button @click="fetchBlackboard()" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition-colors">Search</button>
          <button @click="bbWriteMode = !bbWriteMode" class="bg-gray-800 hover:bg-indigo-900/40 px-4 py-2 rounded-lg text-sm font-medium transition-colors" :class="bbWriteMode ? 'text-indigo-400 border border-indigo-500/40' : ''">+ New</button>
        </div>
        <!-- Namespace quick-filter buttons -->
        <div class="flex gap-1.5 flex-wrap mb-3">
          <template x-for="ns in ['tasks/', 'context/', 'signals/', 'goals/', 'artifacts/', 'history/']" :key="ns">
            <button @click="bbPrefix = (bbPrefix === ns ? '' : ns); fetchBlackboard()"
              class="text-[11px] px-2 py-1 rounded-md border transition-all"
              :class="bbPrefix === ns ? 'border-cyan-500/60 bg-cyan-900/20 text-cyan-300' : 'border-gray-800 text-gray-600 hover:text-gray-400'"
              x-text="ns"></button>
          </template>
          <!-- Writer filter -->
          <select x-show="bbWriters.length > 0" x-model="bbWriterFilter"
            class="text-[11px] px-2 py-1 rounded-md border border-gray-800 bg-gray-900 text-gray-400 ml-auto">
            <option value="">All writers</option>
            <template x-for="w in bbWriters" :key="w">
              <option :value="w" x-text="w"></option>
            </template>
          </select>
        </div>
        <!-- Write form -->
        <div x-show="bbWriteMode" x-cloak class="bg-gray-900 border border-gray-800 rounded-lg p-4 mb-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label for="bb-new-key" class="text-[11px] text-gray-500 mb-1 block">Key</label>
              <input id="bb-new-key" type="text" x-model="bbNewKey" placeholder="context/my_key" class="dash-input w-full">
            </div>
            <div>
              <label for="bb-new-value" class="text-[11px] text-gray-500 mb-1 block">Value (JSON)</label>
              <textarea id="bb-new-value" x-model="bbNewValue" class="dash-textarea w-full" rows="2" placeholder='{"key": "value"}'></textarea>
            </div>
          </div>
          <div class="mt-3 flex gap-2">
            <button @click="writeBlackboard()" class="text-xs px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white transition-colors">Save</button>
            <button @click="bbWriteMode = false" class="text-xs px-3 py-1.5 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 transition-colors">Cancel</button>
          </div>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 text-left text-xs uppercase tracking-wider border-b border-gray-800">
                  <th class="py-3 px-4">Key</th>
                  <th class="py-3 px-4">Value</th>
                  <th class="py-3 px-4">Written By</th>
                  <th class="py-3 px-4">Updated</th>
                  <th class="py-3 px-4">Ver</th>
                  <th class="py-3 px-4"></th>
                </tr>
              </thead>
              <tbody>
                <template x-for="entry in filteredBbEntries" :key="entry.key">
                  <tr class="border-b border-gray-800/40 hover:bg-gray-800/30 transition-colors"
                    :class="bbHighlights.has(entry.key) ? 'flash-yellow' : ''">
                    <td class="py-2.5 px-4 font-mono text-xs text-blue-400" x-text="entry.key"></td>
                    <td class="py-2.5 px-4 max-w-md">
                      <span class="text-gray-300 text-xs font-mono truncate block cursor-pointer" @click="$el.classList.toggle('truncate'); $el.classList.toggle('whitespace-pre-wrap')" x-text="truncateJson(entry.value)" :title="fullJson(entry.value)"></span>
                    </td>
                    <td class="py-2.5 px-4 text-gray-500" x-text="entry.written_by"></td>
                    <td class="py-2.5 px-4 text-gray-600 text-xs font-mono" x-text="entry.updated_at"></td>
                    <td class="py-2.5 px-4 text-gray-600 font-mono" x-text="entry.version"></td>
                    <td class="py-2.5 px-4">
                      <button
                        @click="deleteBlackboard(entry.key)"
                        :disabled="entry.key.startsWith('history/')"
                        class="text-[10px] px-1.5 py-0.5 rounded text-gray-600 hover:text-red-400 hover:bg-red-900/20 transition-colors disabled:opacity-30 disabled:cursor-not-allowed"
                      >Del</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <!-- Loading -->
          <div x-show="filteredBbEntries.length === 0 && bbLoading" class="text-center py-12" x-cloak>
            <div class="inline-flex items-center gap-2 text-gray-600">
              <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
              Loading...
            </div>
          </div>
          <!-- Empty state with namespace guide -->
          <div x-show="filteredBbEntries.length === 0 && !bbLoading" class="text-center py-10 px-6" x-cloak>
            <div class="text-gray-600 mb-3">No entries found</div>
            <div class="text-gray-700 text-xs max-w-md mx-auto space-y-1.5">
              <div><span class="text-cyan-400/60 font-mono">tasks/</span> <span class="text-gray-600">Active task states</span></div>
              <div><span class="text-cyan-400/60 font-mono">context/</span> <span class="text-gray-600">Shared knowledge</span></div>
              <div><span class="text-cyan-400/60 font-mono">signals/</span> <span class="text-gray-600">Cross-agent flags</span></div>
              <div><span class="text-cyan-400/60 font-mono">history/</span> <span class="text-gray-600">Completed results (read-only)</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Automation (Cron with inline schedule editing) -->
      <div x-show="activeTab === 'automation'" x-cloak>
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-medium text-gray-400">Automation</h2>
          <button @click="fetchCronJobs()" class="text-xs px-2 py-1 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 transition-colors">Refresh</button>
        </div>
        <div class="bg-gray-900 border border-gray-800 rounded-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500 text-left text-xs uppercase tracking-wider border-b border-gray-800">
                  <th class="py-3 px-4">ID</th>
                  <th class="py-3 px-4">Agent</th>
                  <th class="py-3 px-4">Schedule</th>
                  <th class="py-3 px-4">Message</th>
                  <th class="py-3 px-4">Type</th>
                  <th class="py-3 px-4">Status</th>
                  <th class="py-3 px-4">Last Run</th>
                  <th class="py-3 px-4">Runs</th>
                  <th class="py-3 px-4">Errors</th>
                  <th class="py-3 px-4">Actions</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="job in cronJobs" :key="job.id">
                  <tr class="border-b border-gray-800/40 hover:bg-gray-800/30">
                    <td class="py-2.5 px-4 font-mono text-xs text-blue-400" x-text="job.id"></td>
                    <td class="py-2.5 px-4 text-white" x-text="job.agent"></td>
                    <td class="py-2.5 px-4">
                      <span x-show="editingCronJob !== job.id" class="font-mono text-gray-300 text-xs cursor-pointer hover:text-indigo-300 transition-colors" @click="editCronJob(job)" x-text="job.schedule"></span>
                      <div x-show="editingCronJob === job.id" class="flex gap-1 items-center">
                        <input type="text" x-model="cronEditSchedule" @keyup.enter="saveCronEdit(job.id)" @keyup.escape="cancelCronEdit()" class="dash-input text-xs py-1 px-2 w-32">
                        <button @click="saveCronEdit(job.id)" class="text-[10px] px-1.5 py-0.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white transition-colors">Save</button>
                        <button @click="cancelCronEdit()" class="text-[10px] px-1.5 py-0.5 rounded bg-gray-800 hover:bg-gray-700 text-gray-400 transition-colors">X</button>
                      </div>
                    </td>
                    <td class="py-2.5 px-4 text-gray-400 text-xs max-w-xs truncate" x-text="job.message"></td>
                    <td class="py-2.5 px-4">
                      <span x-show="job.heartbeat" class="text-pink-400 heartbeat-indicator text-[11px]">heartbeat</span>
                      <span x-show="!job.heartbeat" class="text-gray-600 text-[11px]">cron</span>
                    </td>
                    <td class="py-2.5 px-4">
                      <span class="text-[11px] px-2 py-0.5 rounded-full"
                        :class="job.enabled ? 'bg-green-900/30 text-green-400' : 'bg-gray-800/50 text-gray-500'"
                        x-text="job.enabled ? 'active' : 'paused'"
                      ></span>
                    </td>
                    <td class="py-2.5 px-4 text-gray-600 text-xs font-mono" x-text="job.last_run || 'never'"></td>
                    <td class="py-2.5 px-4 font-mono text-gray-300" x-text="job.run_count"></td>
                    <td class="py-2.5 px-4 font-mono" :class="job.error_count > 0 ? 'text-red-400' : 'text-gray-600'" x-text="job.error_count"></td>
                    <td class="py-2.5 px-4 flex gap-1">
                      <button @click="runCronJob(job.id)" class="text-[10px] px-1.5 py-0.5 rounded bg-gray-800 hover:bg-indigo-900/40 text-gray-400 hover:text-indigo-300 transition-colors">Run</button>
                      <button
                        x-show="job.enabled"
                        @click="pauseCronJob(job.id)"
                        class="text-[10px] px-1.5 py-0.5 rounded bg-gray-800 hover:bg-yellow-900/30 text-gray-400 hover:text-yellow-400 transition-colors"
                      >Pause</button>
                      <button
                        x-show="!job.enabled"
                        @click="resumeCronJob(job.id)"
                        class="text-[10px] px-1.5 py-0.5 rounded bg-gray-800 hover:bg-green-900/30 text-gray-400 hover:text-green-400 transition-colors"
                      >Resume</button>
                      <button @click="deleteCronJob(job.id)"
                        class="text-[10px] px-1.5 py-0.5 rounded bg-gray-800 hover:bg-red-900/30 text-gray-400 hover:text-red-400 transition-colors"
                      >Del</button>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
          <div x-show="cronJobs.length === 0" class="text-center py-12 text-gray-600">
            No automation jobs configured
          </div>
        </div>
      </div>

      <!-- System (Costs + Infrastructure) -->
      <div x-show="activeTab === 'system'" x-cloak>
        <!-- Costs -->
        <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Costs</div>
        <div>
          <div class="flex items-center justify-between mb-4">
            <div class="flex gap-0.5 bg-gray-800/50 rounded-lg p-0.5">
              <template x-for="p in ['today', 'week', 'month']" :key="p">
                <button
                  @click="costPeriod = p; fetchCosts()"
                  class="px-3 py-1.5 rounded-md text-sm font-medium transition-all"
                  :class="costPeriod === p ? 'bg-gray-700 text-white shadow-sm' : 'text-gray-500 hover:text-gray-300'"
                  x-text="p.charAt(0).toUpperCase() + p.slice(1)"
                ></button>
              </template>
            </div>
            <div class="text-sm text-gray-400" x-show="costData.agents && costData.agents.length > 0">
              Total: <span class="text-white font-mono font-medium" x-text="formatCost(costTotal)"></span>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
              <div class="h-72" x-show="costData.agents && costData.agents.length > 0">
                <canvas id="costChart"></canvas>
              </div>
              <div x-show="!costData.agents || costData.agents.length === 0" class="flex items-center justify-center h-72 text-gray-600">
                No cost data for this period
              </div>
            </div>
            <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
              <div class="text-xs text-gray-500 uppercase tracking-wider mb-4">Budget Status</div>
              <div class="space-y-4">
                <template x-for="item in costData.agents || []" :key="item.agent">
                  <div>
                    <div class="flex justify-between text-sm mb-1">
                      <span class="text-white font-medium" x-text="item.agent"></span>
                      <div class="flex items-center gap-3">
                        <span class="text-gray-500 text-xs font-mono" x-text="item.tokens.toLocaleString() + ' tok'"></span>
                        <span class="text-gray-300 font-mono text-xs" x-text="formatCost(item.cost)"></span>
                      </div>
                    </div>
                    <div x-show="costData.budgets && costData.budgets[item.agent]">
                      <div class="w-full bg-gray-800 rounded-full h-1.5">
                        <div class="h-1.5 rounded-full transition-all duration-500"
                          :class="item.cost / (costData.budgets?.[item.agent]?.daily_limit || 1) > 0.8 ? 'bg-red-500' : 'bg-indigo-500'"
                          :style="'width:' + Math.min(100, (item.cost / (costData.budgets?.[item.agent]?.daily_limit || 1)) * 100) + '%'"
                        ></div>
                      </div>
                      <div class="text-[10px] text-gray-700 mt-1 font-mono" x-text="formatCost(item.cost) + ' / ' + formatCost(costData.budgets?.[item.agent]?.daily_limit || 0) + ' daily'"></div>
                    </div>
                  </div>
                </template>
                <div x-show="!costData.agents || costData.agents.length === 0" class="text-gray-600 text-sm py-4 text-center">Budgets appear once agents incur costs</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Infrastructure -->
        <div class="text-xs text-gray-500 uppercase tracking-wider mb-3 mt-6">Infrastructure</div>
        <div>
          <div x-show="!settingsData" class="text-center py-12 text-gray-600">Loading...</div>
          <template x-if="settingsData">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <!-- Credentials -->
              <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Credentials</div>
                <div class="text-sm text-gray-400 mb-2">
                  <span x-text="settingsData.credentials.count"></span> credential(s) configured
                </div>
                <div class="space-y-1 mb-3">
                  <template x-for="name in settingsData.credentials.names" :key="name">
                    <div class="flex items-center gap-2 text-xs">
                      <span class="w-2 h-2 rounded-full bg-green-500/50"></span>
                      <span class="text-gray-300 font-mono" x-text="name"></span>
                    </div>
                  </template>
                </div>
                <div class="border-t border-gray-800 pt-3">
                  <div class="text-xs text-gray-500 mb-2">Add credential</div>
                  <div class="flex gap-2">
                    <input type="text" x-model="credService" class="dash-input flex-1" placeholder="Service (e.g. openai)">
                    <input type="password" x-model="credKey" class="dash-input flex-1" placeholder="API key">
                    <button @click="addCredential()" class="text-xs px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white transition-colors">Add</button>
                  </div>
                </div>
              </div>
              <!-- PubSub subscriptions -->
              <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">PubSub Subscriptions</div>
                <div x-show="Object.keys(settingsData.pubsub_subscriptions || {}).length === 0" class="text-gray-600 text-sm">No subscriptions</div>
                <div class="space-y-2">
                  <template x-for="[topic, agents] in Object.entries(settingsData.pubsub_subscriptions || {})" :key="topic">
                    <div>
                      <span class="text-xs text-cyan-400 font-mono" x-text="topic"></span>
                      <span class="text-gray-600 text-xs mx-1">&rarr;</span>
                      <span class="text-xs text-gray-400" x-text="agents.join(', ')"></span>
                    </div>
                  </template>
                </div>
              </div>
              <!-- Model pricing -->
              <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Model Pricing (per 1K tokens)</div>
                <div class="space-y-1 max-h-60 overflow-y-auto custom-scrollbar">
                  <template x-for="[model, costs] in Object.entries(settingsData.model_costs || {})" :key="model">
                    <div class="flex justify-between text-xs">
                      <span class="text-gray-400 font-mono" x-text="model"></span>
                      <div class="flex gap-3">
                        <span class="text-gray-500">in: <span class="text-gray-300" x-text="'$' + costs.input_per_1k.toFixed(5)"></span></span>
                        <span class="text-gray-500">out: <span class="text-gray-300" x-text="'$' + costs.output_per_1k.toFixed(5)"></span></span>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
              <!-- Browser backends -->
              <div class="bg-gray-900 border border-gray-800 rounded-lg p-4">
                <div class="text-xs text-gray-500 uppercase tracking-wider mb-3">Browser Backends</div>
                <div class="space-y-2">
                  <template x-for="b in settingsData.browser_backends || []" :key="b.name">
                    <div>
                      <span class="text-sm text-white font-medium" x-text="b.label || b.name"></span>
                      <div class="text-xs text-gray-500 mt-0.5" x-text="b.description || ''"></div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

    </main>
  </div>

  <!-- Alpine.js (deferred) -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"></script>
  <script src="/dashboard/static/js/websocket.js"></script>
  <script src="/dashboard/static/js/app.js"></script>
</body>
</html>
